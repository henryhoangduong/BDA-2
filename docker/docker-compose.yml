version: "3.9"
name: bda

services:
  # server:
  #   image: henryhoangduong/bda:latest
  #   environment:
  #     - REDIS_HOST=redis
  #     - CELERY_BROKER_URL=redis://redis:6379/0
  #     - CELERY_RESULT_BACKEND=redis://redis:6379/1
  #     - PYTHONPATH=/app
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - DEVICE=${DEVICE:-cpu}
  #     - SUPABASE_URL
  #     - SUPABASE_JWT_SECRET
  #     - ANON_KEY
  #     - SUPABASE_PUBLIC_KEY
  #     - POSTGRES_HOST
  #     - POSTGRES_PORT
  #     - POSTGRES_USER
  #     - POSTGRES_PASSWORD
  #     - POSTGRES_DB
  #   ports:
  #     - "5005:5005"
    # volumes:
    #   - ../config.yaml:/app/config.yaml
    #   - ../uploads:/app/uploads:rw
    #   - ../markdown:/app/markdown:rw
    #   - ../vector_stores:/app/vector_stores:rw
    # depends_on:
    #   - redis
    # networks:
    #   - bda_network
    # runtime: ${RUNTIME:+${RUNTIME}}
    # entrypoint: ["/app/docker/docker-entrypoint.sh"]
    # command:
    #   [
    #     "python",
    #     "-m",
    #     "uvicorn",
    #     "simba.__main__:create_app",
    #     "--host",
    #     "0.0.0.0",
    #     "--port",
    #     "5005",
    #     "--factory",
    #   ]

  celery_worker:
    image: henryhoangduong/bda:latest
    # env_file:
    #   - ../.env
    environment:
      - REDIS_HOST
      - CELERY_BROKER_URL
      - CELERY_RESULT_BACKEND
      - PYTHONPATH=/app
      - OPENAI_API_KEY
      - DEVICE=${DEVICE:-cpu}
      - SUPABASE_URL
      - SUPABASE_JWT_SECRET
      - ANON_KEY
      - SUPABASE_PUBLIC_KEY
      - POSTGRES_HOST
      - POSTGRES_PORT
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - POSTGRES_DB
  # volumes:
  #   - ../config.yaml:/app/config.yaml
  #   - ../uploads:/app/uploads:rw
  #   - ../vector_stores:/app/vector_stores:rw
    depends_on:
      - redis
    networks:
      - bda_network
    runtime: ${RUNTIME:+${RUNTIME}}
  # entrypoint: ["/app/docker-entrypoint.sh"]
    command:
      [
        "celery",
        "-A",
        "simba.core.celery_config.celery_app",
        "worker",
        "--loglevel=info",
        "-Q",
        "parsing",
      ]

  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   networks:
  #     - bda_network
  #   volumes:
  #     - redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 5s
  #     timeout: 3s
  #     retries: 3

  # frontend:
  #   image: frontend-web:latest
  #   ports:
  #     - "5173:5173"
  #   volumes:
  #     - ../frontend:/app
  #     - /app/node_modules
  #   environment:
  #     - VITE_API_URL=http://localhost:5005
  #     - NODE_ENV=development
  #   networks:
  #     - simba_network
  #   restart: unless-stopped

  # ollama:
  #   image: ollama/ollama:latest
  #   environment:
  #     - OLLAMA_ORIGINS=*
  #   volumes:
  #     - ollama_models:/root/.ollama
  #   ports:
  #     - "11434:11434"
  #   networks:
  #     - bda_network
  #   runtime: ${RUNTIME:+${RUNTIME}}
  #   profiles:
  #     - ${RUN_OLLAMA:-default}

networks:
  bda_network:
    name: bda_network
    driver: bridge
# external: true

volumes:
  redis_data:
  # ollama_models:
